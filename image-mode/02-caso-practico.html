<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Creación de una máquina virtual con bootc containers :: RHEL Image Mode</title>
    <link rel="canonical" href="https://redhat-iberia.github.io/image-mode/image-mode/02-caso-practico.html">
    <link rel="prev" href="01-introduccion.html">
    <link rel="next" href="03-resources.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-iberia.github.io/image-mode">RHEL Image Mode</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="image-mode" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-introduccion.html">1. Introducción</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-introduccion.html#bootable">Bootable Containers</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-caso-practico.html">2. Caso Práctico</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#descripcion">Descripción</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crear-images">Creación de la primera imagen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#update-rollback">Actualización y rollback</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-resources.html">Recursos</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">RHEL Image Mode</a></li>
    <li><a href="02-caso-practico.html">2. Caso Práctico</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-iberia/microlab-image_mode/edit/master/documentation/modules/ROOT/pages/02-caso-practico.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Creación de una máquina virtual con bootc containers</h1>
<div class="sect1">
<h2 id="descripcion"><a class="anchor" href="#descripcion"></a>Descripción</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En este caso práctico, crearemos una máquina virtual (VM) a partir de una imágen de contenedor.</p>
</div>
<div class="paragraph">
<p>Veremos cómo bootc aprovecha la tecnología de contenedores existente para:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crear al aplicación en términos de su contenedor en tiempo de creación - el sistema no se cambia una vez desplegado.</p>
</li>
<li>
<p>Acceder automáticamente al registro de imágenes del contenedor desplegado para automáticamente actualizar el sistema.</p>
</li>
<li>
<p>Revertir el último cambio.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crear-images"><a class="anchor" href="#crear-images"></a>Creación de la primera imagen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La definición de un contenedor es prácticamente igual que la de un contenedor tradicional, lo que cambia es la cláusula <code>FROM</code>.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">FROM registry.redhat.io/rhel9/rhel-bootc:9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>En nuestro ejemplo simplemente crearemos un contenedor que instala y configura un servidor apache para servir contenido mediante el protocolo HTTPS.</p>
</div>
<div class="paragraph">
<p>Bootc viene instalado en esas imágenes junto con un temporizador que periódicamente comprueba si existen actualizaciones y aplicarlas.</p>
</div>
<div class="paragraph">
<p>Para nuestro caso práctico vamos a crear un sistema con el temporizador comprobando si existen actualizaciones cada 30 segundos. Para esto sobreescribimos
el temporizador en el momento de la creación de la imagen. Usamos la Containerfile:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">FROM registry.redhat.io/rhel9/rhel-bootc:9.4
RUN /usr/bin/dnf -y install firewalld httpd php mod_ssl langpacks-es &amp;&amp; /usr/bin/rm -f /etc/httpd/conf.d/welcome.conf &amp;&amp; /usr/bin/systemctl enable httpd
COPY bootc-fetch-apply-updates.timer /lib/systemd/system/
COPY motd /etc/motd.d/
COPY hostname /etc/
COPY index.php /var/www/html
COPY httpd.key /etc/pki/tls/private/
COPY httpd.crt /etc/pki/tls/certs/
COPY cacert.pem /etc/pki/tls/certs/
COPY ssl.conf /etc/httpd/conf.d/
COPY public.xml /etc/firewalld/zones/
COPY registries.conf /etc/containers/
EXPOSE 443
CMD [ "/sbin/init" ]</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Como hemos comentado <strong>bootc containers</strong> se encuentra en Technology Preview y todavía hay opciones de configuración que se están implementando. Por ese motivo hemos tenido que recurrir a:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">RUN /usr/bin/dnf -y install firewalld httpd php mod_ssl langpacks-es &amp;&amp; /usr/bin/rm -f /etc/httpd/conf.d/welcome.conf &amp;&amp; /usr/bin/systemctl enable httpd</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El timer de systemd que se encarga de comprobar si hay actualizaciones:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ cat bootc-fetch-apply-updates.timer
[Unit]
Description=Apply bootc updates
Documentation=man:bootc(8)
ConditionPathExists=/run/ostree-booted

[Timer]
OnBootSec=30seconds
# This time is relatively arbitrary and obviously expected to be overridden/changed
OnUnitActiveSec=30seconds
OnUnitInactiveSec=30seconds
# When deploying a large number of systems, it may be beneficial to increase this value to help with load on the registry.
RandomizedDelaySec=5seconds

[Install]
WantedBy=timers.target
$</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Abrimos una terminal y nos conectamos por ssh con el usuario <strong>demouser</strong> al host <strong>imagemode</strong> y creamos el contedor utilizando podman:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[imagemode@workstation ~]$ ssh demouser@imagemode
[demouser@imagemode ~]$ sudo su -
[root@imagemode ~]# cd image-mode
[root@imagemode ~]# cat create-container.sh
#!/bin/bash

podman build -f Containerfile.rhel9.4 -t rhel-bootc-vm:latest .

if [ $? -ne 0 ]
then
  echo "ERROR AL CONSTRUIR LA IMAGEN"
  exit 1
fi

podman tag localhost/rhel-bootc-vm:latest registry.lab.melmac.univ:5000/rhel-bootc-vm:latest

if [ $? -ne 0 ]
then
  echo "ERROR TAGEAR LA IMAGEN"
  exit 1
fi

podman push registry.lab.melmac.univ:5000/rhel-bootc-vm:latest

if [ $? -ne 0 ]
then
  echo "ERROR TAGEAR AL HACER PUSH"
  exit 1
fi
[root@imagemode ~]# bash create-container.sh
...
[root@imagemode ~]# podman images
REPOSITORY                                    TAG         IMAGE ID       CREATED           SIZE
localhost/rhel-bootc-vm                       latest       cc3e1af1b6a6  2 minutes ago     1.75 GB
...
[root@imagemode ~]#</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En caso de bootable containers, no vamos a ejecutar esas imágenes sobre sistemas existentes sino vamos a crear sistemas con esos contenedores ya instalados.</p>
</div>
<div class="paragraph">
<p>Podemos crear sistemas de varias maneras: con imágenes para máquinas virtuales o también creando DVDs (ISO) que podemos utilizar para automáticamente instalar
un servidor baremetal con <a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/automatically_installing_rhel/automated-installation-workflow_rhel-installer#automated-installation-workflow_rhel-installer">kickstart</a>.</p>
</div>
<div class="paragraph">
<p>Aquí vamos a utilizar <a href="https://github.com/osbuild/bootc-image-builder">bootc-image-builder</a> para crear una VM de tipo KVM para ejecutarla en Linux utilizando <a href="https://libvirt.org">libvirt</a>.</p>
</div>
<div class="paragraph">
<p>El bootc-image-builder está diseñado para ejecutarse desde un contenedor. Creamos un archivo <code>config.toml</code> para configurar un usuario y usamos podman para ejecutar la aplicación con nuestro container. Mas información en <a href="https://github.com/osbuild/bootc-image-builder">bootc-image-builder</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemode ~]#  mkdir output
image-mode # cat config.toml
<a id="blueprint.customizations.user"></a>
name = "demouser"
password = "redhat"
key = "ssh-rsa ...."
groups = ["wheel"]

[root@imagemode image-mode]#  cat creating-vm.sh
#!/bin/bash

/usr/bin/podman run --rm -it --privileged --pull=newer --security-opt label=type:unconfined_t \
           -v $(pwd)/config.toml:/config.toml:ro -v $(pwd)/output:/output -v /var/lib/containers/storage:/var/lib/containers/storage \
           registry.redhat.io/rhel9/bootc-image-builder:latest \
           --type qcow2 --local registry.lab.melmac.univ:5000/rhel-bootc-vm:latest

if [ $? -ne 0 ]
then
  echo "Ocurrio un error creando la VM"
  exit 1
fi

/usr/bin/qemu-img convert -f qcow2 -O qcow2 -o lazy_refcounts=on $(pwd)/output/qcow2/disk.qcow2 /imagemode/image-mode-test.qcow2
[root@imagemode image-mode]# bash creating-vm.sh
...
[root@imagemode image-mode]#</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cuando termine la ejecución de este script se habrá creado el disco de la máquina virtual y quedará dentro del directorio <strong>output</strong>. El script se encarga de copiar dicho disco a una unidad compartida para poder ejecutar la máquina virtual.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Utilizando los comandos <strong>cd</strong> y <strong>ls</strong> puedes navegar por el directorio output para ver que se ha generado.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el portátil ya se encuentra creada una máquina virtual para ejecutar la máquina que hemos creado. El script anterior al copiar el disco creado a la carpeta compartida ha sobreescrito el disco existente y al arrancar la máquina virtual arrancará con el disco que hemos creado.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para arrancar la máquina virtual con el disco creado en el entorno gráfico del portátil vamos al launcher situado abajo y pinchamos en <strong>Launch VM</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/launchvm.png" alt="launchvm">
</div>
</div>
<div class="paragraph">
<p>Una vez arrancada la máquina virtual:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/vm.png" alt="vm">
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora podemos conectarnos a la máquina virtual que hemos creado y explorar.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Tenemos dos formas de conectarnos, nos podemos conectar por ssh utilizando las credenciales definidas en el fichero <strong>config.toml</strong>:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemode image-mode]# ssh demouser@imagemodetest
[demouser@imagemodetest ~]$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como en el fichero de configuración <strong>config.toml</strong> hemos incluido la clave pública no nos pedirá contraseña.</p>
</div>
<div class="paragraph">
<p>La otra forma de conectarnos es a través de la consola que hemos abierto con <strong>Launch VM</strong>. En este caso si nos pedirá constraseña. El usuario y la contraseña los tenemos en el fichero <strong>config.toml</strong>.</p>
</div>
<div class="paragraph">
<p>Desde el portátil, abre una pestaña del navegador y conectate a (A la máquina que acabas de creat)[<a href="https://imagemodetest.lab.melmac.univ" class="bare">https://imagemodetest.lab.melmac.univ</a>] para comprobar sí la aplicación funciona correctamente.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Como ejemplo hemos desplegado una apliación muy simple ya que el objetivo de este lab es ilustrar como se puede automatizar el despliegue no solo del sistema, sino que también de las aplicaciones.</p>
</div>
<div class="paragraph">
<p>Como en el mundo real las aplicaciones son más complejas de instalar el <strong>Containerfile</strong> utilizado deberá contener todos los pasos para desplegar la aplicación.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="update-rollback"><a class="anchor" href="#update-rollback"></a>Actualización y rollback</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>bootc</code> es el comando que maneja los contenedores dentro de la VM. Viene con un temporizador que regularmente activa un servicio de systemd.
Ese servicio, si detecta que una nueva imagen está disponible, la descarga y reinicia el sistema para aplicarla.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Después de hacer login en la máquina comprobamos que el temporizador está activo:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemode image-mode]# ssh demouser@imagemodetest
Bienvenido a una maquina desplegada con bootc-container-vm v1
[demouser@imagemodetest ~]$ sudo su -
[sudo] password for demouser:
Last login: Fri Oct  4 09:24:32 UTC 2024 on pts/0
[root@imagemodetest ~]# systemctl status bootc-fetch-apply-updates.timer
● bootc-fetch-apply-updates.timer - Apply bootc updates
     Loaded: loaded (/usr/lib/systemd/system/bootc-fetch-apply-updates.timer; disabled; preset: disabled)
     Active: active (waiting) since Fri 2024-10-04 09:23:58 UTC; 14min ago
      Until: Fri 2024-10-04 09:23:58 UTC; 14min ago
    Trigger: Fri 2024-10-04 09:39:24 UTC; 27s left
   Triggers: ● bootc-fetch-apply-updates.service
       Docs: man:bootc(8)

Oct 04 09:23:58 imagemodetest.lab.melmac.univ systemd[1]: Started Apply bootc updates.

[root@imagemodetest ~]#</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Observar que al iniciar sesión con el usuario <strong>demouser</strong> veremos un mensaje de bienvenida <strong>Bienvenido a una maquina desplegada con bootc-container-vm v1</strong>. Este mensaje se modificará en la actualización que haremos a continuación.</p>
</div>
<div class="paragraph">
<p>Ahora vamos a crear una nueva imagen y subirla al registro. Eso hará que el sistema se autoactualice.</p>
</div>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En una consola de la máquina <strong>imagemodetest</strong> comprobaremos las versiones disponibles que tenemos en la máquina:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemodetest ~]# rpm-ostree status
State: idle
Deployments:
● ostree-unverified-registry:registry.lab.melmac.univ:5000/rhel-bootc-vm:latest
                   Digest: sha256:90ddf6a6f750042ac4c320e631a94a65cba7d62361b00b6596258cd419083a7b
                  Version: 9.20240930.0 (2024-10-04T09:19:28Z)
[root@imagemodetest ~]#</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vemos que tenemos únicamente una versión disponible en la máquina y que se encuentra en el registry <strong>registry.lab.melmac.univ:5000/rhel-bootc-vm:latest</strong>. Este es el contenedor que creamos y que utilizamos para construir la máquina virtual.</p>
</div>
<div class="paragraph">
<p>Ahora observaremos el estado del servicio <strong>bootc-fetch-apply-updates</strong>:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemodetest ~]# journalctl -f -u bootc-fetch-apply-updates
Oct 04 09:40:49 imagemodetest.lab.melmac.univ bootc[1572]: No changes in registry.lab.melmac.univ:5000/rhel-bootc-vm:latest =&gt; sha256:90ddf6a6f750042ac4c320e631a94a65cba7d62361b00b6596258cd419083a7b
Oct 04 09:40:49 imagemodetest.lab.melmac.univ bootc[1572]: No update available.
Oct 04 09:40:49 imagemodetest.lab.melmac.univ systemd[1]: bootc-fetch-apply-updates.service: Deactivated successfully.
Oct 04 09:40:49 imagemodetest.lab.melmac.univ systemd[1]: Finished Apply bootc updates.
Oct 04 09:41:29 imagemodetest.lab.melmac.univ systemd[1]: Starting Apply bootc updates...
Oct 04 09:41:29 imagemodetest.lab.melmac.univ bootc[1584]: Fetching ostree-unverified-registry:registry.lab.melmac.univ:5000/rhel-bootc-vm:latest
Oct 04 09:41:29 imagemodetest.lab.melmac.univ bootc[1584]: No changes in registry.lab.melmac.univ:5000/rhel-bootc-vm:latest =&gt; sha256:90ddf6a6f750042ac4c320e631a94a65cba7d62361b00b6596258cd419083a7b
Oct 04 09:41:29 imagemodetest.lab.melmac.univ bootc[1584]: No update available.
Oct 04 09:41:29 imagemodetest.lab.melmac.univ systemd[1]: bootc-fetch-apply-updates.service: Deactivated successfully.
Oct 04 09:41:29 imagemodetest.lab.melmac.univ systemd[1]: Finished Apply bootc updates.
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>En otra consola, en la máquina <strong>imagemode</strong>  utilizaremos el Containerfile <strong>Containerfile.rhel9.4.mod</strong> donde hemos modificado algunas cosas, como instalar el paquete <strong>tmux</strong>. Ejecutamos el script <strong>bash create-container-mod.sh</strong> que se encargará de crear la nueva version del <strong>bootc container</strong>. En este caso no será necesario crear la imagen de la máquina virtual ya que ya existe y lo único que nos interesa es actualizar la máquina virtual con las nuevas modificaciones:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemode image-mode]# cat Containerfile.rhel9.4.mod
FROM registry.redhat.io/rhel9/rhel-bootc:9.4
RUN /usr/bin/dnf -y install firewalld httpd php mod_ssl langpacks-es tmux &amp;&amp; /usr/bin/rm -f /etc/httpd/conf.d/welcome.conf &amp;&amp; /usr/bin/systemctl enable httpd
COPY bootc-fetch-apply-updates.timer /lib/systemd/system/
COPY motd2 /etc/motd.d/motd
COPY hostname /etc/
COPY index2.php /var/www/html/index.php
COPY rhel-logo.png /var/www/html/
COPY httpd.key /etc/pki/tls/private/
COPY httpd.crt /etc/pki/tls/certs/
COPY cacert.pem /etc/pki/tls/certs/
COPY ssl.conf /etc/httpd/conf.d/
COPY public.xml /etc/firewalld/zones/
COPY registries.conf /etc/containers/
EXPOSE 443
CMD [ "/sbin/init" ]
[root@imagemode image-mode]# bash create-container-mod.sh
...
[root@imagemode image-mode]#</code></pre>
</div>
</div>
<div class="paragraph">
<p>Volvemos a la consola de la máquina <strong>imagemodetest</strong> para ver el estado del servicio <strong>bootc-fetch-apply-updates</strong>. Veremos que encuentra la actualización, descarga los datos y reinicia el sistema para actualizarlo.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemodetest ~]# journalctl -f -u bootc-fetch-apply-updates
....
Oct 04 10:12:22 imagemodetest.lab.melmac.univ systemd[1]: Starting Apply bootc updates...
Oct 04 10:12:22 imagemodetest.lab.melmac.univ bootc[2362]: Fetching ostree-unverified-registry:registry.lab.melmac.univ:5000/rhel-bootc-vm:latest
Oct 04 10:12:22 imagemodetest.lab.melmac.univ bootc[2362]: layers already present: 0; layers needed: 78 (1.0 GB)
Oct 04 10:12:22 imagemodetest.lab.melmac.univ bootc[2362]: layers already present: 0; layers needed: 78 (1.0 GB)
Oct 04 10:12:42 imagemodetest.lab.melmac.univ bootc[2362]: Image contains non-ostree compatible file paths: run: 4

Broadcast message from <a href="mailto:root@imagemodetest.lab.melmac.univ">root@imagemodetest.lab.melmac.univ</a> (Fri 2024-10-04 10:12:50 UTC):

The system will reboot now!

Connection to imagemodetest closed by remote host.
Connection to imagemodetest closed.
[root@imagemode image-mode]#</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ha detectado que hay una actualización nueva, la ha descargado, la ha aplicado y reiniciado el servicio. Nos conectamos de nuevo en cuando haya reiniciado, veremos que el proceso de actualización es muy rápido:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemode image-mode]# ssh demouser@imagemodetest
Bienvenido a una maquina desplegada con bootc-container-vm v2
Last login: Fri Oct  4 10:07:25 2024 from 192.168.122.202
[demouser@imagemodetest ~]$ sudo su -
[sudo] password for demouser:
Last login: Fri Oct  4 10:07:31 UTC 2024 on pts/0
[root@imagemodetest ~]# rpm-ostree status
State: idle
Deployments:
● ostree-unverified-registry:registry.lab.melmac.univ:5000/rhel-bootc-vm:latest
                   Digest: sha256:5360e472e60cc8d4c2f01dcaf333c0eba96150dbd79d46d9f15258e687415647
                  Version: 9.20240930.0 (2024-10-04T10:11:53Z)

  ostree-unverified-registry:registry.lab.melmac.univ:5000/rhel-bootc-vm:latest
                   Digest: sha256:90ddf6a6f750042ac4c320e631a94a65cba7d62361b00b6596258cd419083a7b
                  Version: 9.20240930.0 (2024-10-04T09:19:28Z)
[root@imagemodetest ~]#</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora vemos que tenemos dos versiones disponibles, la antigua generada cuando creamos la máquina virtual y la nueva que hemos creado que vemos que es la seleccionada.</p>
</div>
<div class="paragraph">
<p>Después del reinicio, hacemos login y comprobamos que efectivamente, el sistema ha sido actualizado.</p>
</div>
<div class="paragraph">
<p>Si encontramos problemas con esta actualización podemos revertirla sin problema. Manualmente lo conseguimos ejecutando:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemodetest ~]# bootc rollback
bootfs is sufficient for calculated new size: 0 bytes
Next boot: rollback deployment
[root@imagemodetest ~]#  reboot</code></pre>
</div>
</div>
<div class="paragraph">
<p>El sistema reiniciará y veremos que nos encontramos en la versión previa:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemode ~]# ssh demouser@imagemodetest
Bienvenido a una maquina desplegada con bootc-container-vm v1
Last login: Fri Oct  4 10:45:15 2024 from 192.168.122.202
[demouser@imagemodetest ~]$ rpm-ostree status
State: idle
Deployments:
● ostree-unverified-registry:registry.lab.melmac.univ:5000/rhel-bootc-vm:latest
                   Digest: sha256:90ddf6a6f750042ac4c320e631a94a65cba7d62361b00b6596258cd419083a7b
                  Version: 9.20240930.0 (2024-10-04T09:19:28Z)

  ostree-unverified-registry:registry.lab.melmac.univ:5000/rhel-bootc-vm:latest
                   Digest: sha256:5360e472e60cc8d4c2f01dcaf333c0eba96150dbd79d46d9f15258e687415647
                  Version: 9.20240930.0 (2024-10-04T10:11:53Z)
[demouser@imagemodetest ~]$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos ver que el mensaje de bienvenida vuelve a mostrar <strong>Bienvenido a una maquina desplegada con bootc-container-vm v1</strong> y que la versión activa es la primera que instalamos.</p>
</div>
<div class="paragraph">
<p>Si queremos evitar que el sistema se auto-actualice de nuevo a la versión errónea, debemos deshabilitar el temporizador:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemodetest ~]# systemctl disable --now bootc-fetch-apply-updates.timer</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">

</div>
</div>
<div class="paragraph">
<p>Se puede detectar si la actualización no funciona de forma correcta y realizar el rollback de forma autómatica. Este método se hace utilizando <a href="https://github.com/fedora-iot/greenboot">greenboot</a> que es el mismo mecanismo que utiliza la versión de RHEL para Edge. En estos momentos esta funcionalidad se está integrando con los contenedores <strong>bootc</strong> y estará disponible en el futuro.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="conclusriones" class="paragraph">
<p>== Conclusiones</p>
</div>
<div class="paragraph">
<p>Hemos visto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Como crear una máquina virtual a partir de un contenedor.</p>
</li>
<li>
<p>El proceso de actualizar es tan sencillo como recrear el contenedor a partir del que hemos creado la máquina virtual.</p>
</li>
<li>
<p>La actualización se puede hacer de forma automática, aunque también se puede lanzar de forma manual mediante automatismos.</p>
</li>
<li>
<p>El proceso de actualización es muy rápido.</p>
</li>
<li>
<p>El proceso de marcha atrás es muy rápido y sencillo.</p>
</li>
<li>
<p>Existe una forma automática de detectar si la actualización no funciona correctamente de forma automática y hacer el rollback automático a la versión anterior y tener el sistema funcional.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-introduccion.html">1. Introducción</a></span>
  <span class="next"><a href="03-resources.html">Recursos</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
