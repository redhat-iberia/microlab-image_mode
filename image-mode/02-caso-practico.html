<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Creación de una máquina virtual con bootc containers :: RHEL Image Mode</title>
    <link rel="canonical" href="https://redhat-iberia.github.io/image-mode/image-mode/02-caso-practico.html">
    <link rel="prev" href="01-introduccion.html">
    <link rel="next" href="03-resources.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-iberia.github.io/image-mode">RHEL Image Mode</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="image-mode" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-introduccion.html">1. Introducción</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-introduccion.html#bootable">Bootable Containers</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-caso-practico.html">2. Caso Práctico</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#descripcion">Descripción</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#crear-images">Creación de la primera imagen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#update-rollback">Actualización y rollback</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-resources.html">Recursos</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">RHEL Image Mode</a></li>
    <li><a href="02-caso-practico.html">2. Caso Práctico</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-iberia/microlab-image_mode/edit/master/documentation/modules/ROOT/pages/02-caso-practico.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Creación de una máquina virtual con bootc containers</h1>
<div class="sect1">
<h2 id="descripcion"><a class="anchor" href="#descripcion"></a>Descripción</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En este caso práctico, crearemos una máquina virtual (VM) a partir de una imágen de contenedor.</p>
</div>
<div class="paragraph">
<p>Veremos cómo bootc aprovecha la tecnología de contenedores existente para:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crear al aplicación en términos de su contenedor en tiempo de creación - el sistema no se cambia una vez desplegado.</p>
</li>
<li>
<p>Acceder automáticamente al registro de imágenes del contenedor desplegado para automáticamente actualizar el sistema.</p>
</li>
<li>
<p>Revertir el último cambio.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crear-images"><a class="anchor" href="#crear-images"></a>Creación de la primera imagen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La definición de un contenedor es prácticamente igual que la de un contenedor tradicional, lo que cambia es la cláusula <code>FROM</code>.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">FROM registry.redhat.io/rhel9/rhel-bootc:9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>En nuestro ejemplo simplemente crearemos un contenedor que instala y configura un servidor apache para servir contenido mediante el protocolo HTTPS.</p>
</div>
<div class="paragraph">
<p>Bootc viene instalado en esas imágenes junto con un temporizador que periódicamente comprueba si existen actualizaciones y aplicarlas.</p>
</div>
<div class="paragraph">
<p>Para nuestro caso práctico vamos a crear un sistema con el temporizador comprobando si existen actualizaciones cada 30 segundos. Para esto sobreescribimos
el temporizador en el momento de la creación de la imagen. Usamos la Containerfile:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">FROM registry.redhat.io/rhel9/rhel-bootc:9.4
RUN /usr/bin/dnf -y install firewalld httpd php mod_ssl langpacks-es &amp;&amp; /usr/bin/rm -f /etc/httpd/conf.d/welcome.conf &amp;&amp; /usr/bin/systemctl enable httpd
COPY bootc-fetch-apply-updates.timer /lib/systemd/system/
COPY motd /etc/motd.d/
COPY index.php /var/www/html
COPY httpd.key /etc/pki/tls/private/
COPY httpd.crt /etc/pki/tls/certs/
COPY cacert.pem /etc/pki/tls/certs/
COPY ssl.conf /etc/httpd/conf.d/
COPY public.xml /etc/firewalld/zones/
EXPOSE 443
CMD [ "/sbin/init" ]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ cat bootc-fetch-apply-updates.timer
[Unit]
Description=Apply bootc updates
Documentation=man:bootc(8)
ConditionPathExists=/run/ostree-booted

[Timer]
OnBootSec=30seconds
# This time is relatively arbitrary and obviously expected to be overridden/changed
OnUnitActiveSec=30seconds
OnUnitInactiveSec=30seconds
# When deploying a large number of systems, it may be beneficial to increase this value to help with load on the registry.
RandomizedDelaySec=5seconds

[Install]
WantedBy=timers.target
$</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Abrimos una terminal y nos conectamos por ssh con el usuario <strong>demouser</strong> al host <strong>imagemode</strong> y creamos el contedor utilizando podman:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[imagemode@workstation ~]$ ssh demouser@imagemode
[demouser@imagemode ~]$ sudo su -
[root@imagemode ~]# cd image-mode
[root@imagemode ~]#  podman build -f Containerfile.rhel9.4 -t rhel-bootc-vm:latest .
...
[root@imagemode ~]# podman images
REPOSITORY                                    TAG         IMAGE ID       CREATED           SIZE
localhost/rhel-bootc-vm                       latest       cc3e1af1b6a6  2 minutes ago     1.75 GB
...
[root@imagemode ~]#</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En caso de bootable containers, no vamos a ejecutar esas imágenes sobre sistemas existentes sino vamos a crear sistemas con esos contenedores ya instalados.</p>
</div>
<div class="paragraph">
<p>Podemos crear sistemas de varias maneras: con imágenes para máquinas virtuales o también creando DVDs (ISO) que podemos utilizar para automáticamente instalar
un servidor baremetal con <a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/automatically_installing_rhel/automated-installation-workflow_rhel-installer#automated-installation-workflow_rhel-installer">kickstart</a>.</p>
</div>
<div class="paragraph">
<p>Aquí vamos a utilizar <a href="https://github.com/osbuild/bootc-image-builder">bootc-image-builder</a> para crear una VM de tipo KVM para ejecutarla en Linux utilizando <a href="https://libvirt.org">libvirt</a>.</p>
</div>
<div class="paragraph">
<p>El bootc-image-builder está diseñado para ejecutarse desde un contenedor. Creamos un archivo <code>config.toml</code> para configurar un usuario y usamos podman para ejecutar la aplicación con nuestro container. Mas información en <a href="https://github.com/osbuild/bootc-image-builder">bootc-image-builder</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@imagemode ~]#  mkdir output
image-mode # cat config.toml
<a id="blueprint.customizations.user"></a>
name = "demouser"
password = "redhat"
key = "ssh-rsa ...."
groups = ["wheel"]

[root@imagemode image-mode]#  cat creating-vm.sh
#!/bin/bash

podman run --rm -it --privileged --pull=newer --security-opt label=type:unconfined_t \
           -v $(pwd)/config.toml:/config.toml:ro -v $(pwd)/output:/output \
           -v /var/lib/containers/storage:/var/lib/containers/storage \
           registry.redhat.io/rhel9/bootc-image-builder:latest \
           --type qcow2 --local registry.melmac.univ:5000/rhel-bootc-vm:latest
[root@imagemode image-mode]# bash creating-vm.sh
...
[root@imagemode image-mode]#</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We then move the VM image file to file that&#8217;s accessible by libvirt and import it.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># qemu-img convert -f qcow2 -O qcow2 -o lazy_refcounts=on ./output/qcow2/disk.qcow2 /var/lib/libvirt/images/disk.qcow2
# virt-install --name vm --os-variant rhel-unknown --memory 2048 --vcpus 2 --nographics --import --disk /var/lib/libvirt/images/disk.qcow2</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now log in and explore the system.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="update-rollback"><a class="anchor" href="#update-rollback"></a>Actualización y rollback</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>bootc</code> es el comando que maneja los contenedores dentro de la VM. Viene con un temporizador que regularmente activa un servicio de systemd.
Ese servicio, si detecta que una nueva imagen está disponible, la descarga y reinicia el sistema para aplicarla.</p>
</div>
<div class="paragraph">
<p>Después de hacer log-in en la máquina comprobamos que el temporizador está activo:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># sudo systemctl status bootc-fetch-apply-updates.timer</code></pre>
</div>
</div>
<div class="paragraph">
<p>En lo que sigue, vamos a crear una nueva imagen y subirla al registro. Eso hará que el sistema se autoactualice. Observaremos en una consola el estado del servicio:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># sudo journalctl -f -u bootc-fetch-apply-updates
Oct 01 16:05:54 localhost.localdomain systemd[1]: Starting Apply bootc updates...
Oct 01 16:05:54 localhost.localdomain bootc[1179]: Fetching ostree-unverified-registry:&lt;registry&gt;/demo:latest
Oct 01 16:05:54 localhost.localdomain bootc[1179]: No changes in &lt;registry&gt;/demo:latest =&gt; sha256:40106b8d8e453901b78398c819a6b95f4d7b55a28b8783d8e19e276197f2f814
Oct 01 16:05:54 localhost.localdomain bootc[1179]: No update available.
Oct 01 16:05:54 localhost.localdomain systemd[1]: bootc-fetch-apply-updates.service: Deactivated successfully.
Oct 01 16:05:54 localhost.localdomain systemd[1]: Finished Apply bootc updates.</code></pre>
</div>
</div>
<div class="paragraph">
<p>En otra consola, cambiamos la Containerfile</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">FROM quay.io/centos-bootc/centos-bootc:stream9
COPY bootc-fetch-apply-updates.timer /lib/systemd/system/
RUN echo v2 &gt; /version</code></pre>
</div>
</div>
<div class="paragraph">
<p>identificando esta nueva version en el archivo <code>/version</code>.</p>
</div>
<div class="paragraph">
<p>Seguimos los mismos pasos como en <a href="#crear-images">Creación de la primera imagen</a>.</p>
</div>
<div class="paragraph">
<p>Veremos, cómo el servicio <code>bootc-fetch-apply-updates</code> encuentra la actualización, descarga los datos y reinicia el sistema.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Oct 01 16:07:29 localhost.localdomain systemd[1]: Starting Apply bootc updates...
Oct 01 16:07:29 localhost.localdomain bootc[1206]: Fetching ostree-unverified-registry:&lt;registry&gt;/demo:latest
Oct 01 16:07:30 localhost.localdomain bootc[1206]: layers already present: 70; layers needed: 1 (141 bytes)
Oct 01 16:07:30 localhost.localdomain bootc[1206]: layers already present: 70; layers needed: 1 (141 bytes)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Después del reinicio, hacemos login y comprobamos que efectivamente, el sistema ha sido actualizado.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ sudo cat /version
v2</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bootc</code> si encontramos problemas con esta actualización podemos revertirla sin problema. Manualmente lo conseguimos ejecutando</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ sudo bootc rollback</code></pre>
</div>
</div>
<div class="paragraph">
<p>El sistema reiniciará y veremos que nos encontramos en la versión previa:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ sudo cat /version
v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si queremos evitar que el sistema se auto-actualice de nuevo a la versión errónea, debemos deshabilitar el temporizador</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ sudo systemctl disable --now bootc-fetch-apply-updates.timer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como hemos visto, <code>bootc</code> integra bien con herramientas existentes de contenedores. Esto significa que también disponemos de <a href="https://github.com/fedora-iot/greenboot">greenboot</a>
para que revertir automáticamente un sistema que no inicie bien después de una actualización.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-introduccion.html">1. Introducción</a></span>
  <span class="next"><a href="03-resources.html">Recursos</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
